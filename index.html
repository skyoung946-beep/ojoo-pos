<script>
    const firebaseConfig = { databaseURL: "https://ojoo-lounge-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let typedPin = "";
    function pressPin(n) { typedPin += n; document.getElementById('pin-view').innerText = "*".repeat(typedPin.length); }
    
    function checkPin() {
        if (typedPin === '1012') { 
            document.getElementById('login-overlay').style.display='none'; 
            startSync(); 
        } else { 
            alert("Wrong PIN"); 
            typedPin = ""; 
            document.getElementById('pin-view').innerText = "****"; 
        }
    }

    // Full Inventory List
    let inventory = [
        { name: "Fan max", cat: "Beverages", price: 0 }, { name: "Bel ice", cat: "Beverages", price: 0 },
        { name: "Chin Chin", cat: "Beverages", price: 0 }, { name: "Wellman", cat: "Beverages", price: 0 },
        { name: "Vitamilk", cat: "Beverages", price: 0 }, { name: "Coke Bottle", cat: "Beverages", price: 0 },
        { name: "Fanta Bottle", cat: "Beverages", price: 0 }, { name: "Malt Bottle", cat: "Beverages", price: 0 },
        { name: "Sprite Bottle", cat: "Beverages", price: 0 }, { name: "Malt Plastic", cat: "Beverages", price: 0 },
        { name: "Frutelli", cat: "Beverages", price: 0 }, { name: "Ceres", cat: "Beverages", price: 0 },
        { name: "Hollandia S/S", cat: "Beverages", price: 0 }, { name: "Hollandia B/S", cat: "Beverages", price: 0 },
        { name: "Can Fanta", cat: "Beverages", price: 0 }, { name: "Can Coke", cat: "Beverages", price: 0 },
        { name: "Pukka Drink", cat: "Beverages", price: 0 }, { name: "Pukka Extra", cat: "Beverages", price: 0 },
        { name: "5 Star", cat: "Beverages", price: 0 }, { name: "Lucozade bottle", cat: "Beverages", price: 0 },
        { name: "Lucozade can", cat: "Beverages", price: 0 }, { name: "Beta Malt", cat: "Beverages", price: 0 },
        { name: "Don Simon S/S", cat: "Beverages", price: 0 }, { name: "Don Simon B/S", cat: "Beverages", price: 0 },
        { name: "Water S/S", cat: "Beverages", price: 0 }, { name: "Water M/S", cat: "Beverages", price: 0 },
        { name: "Water B/S", cat: "Beverages", price: 0 }, { name: "Tampico S/S", cat: "Beverages", price: 0 },
        { name: "Tampico M/S", cat: "Beverages", price: 0 }, { name: "Vim Energy", cat: "Beverages", price: 0 },
        { name: "Storm B/S", cat: "Beverages", price: 0 }, { name: "Storm S/S", cat: "Beverages", price: 0 },
        { name: "Wheat B/S", cat: "Beverages", price: 0 }, { name: "Wheat S/S", cat: "Beverages", price: 0 },
        { name: "Blue Jeans", cat: "Beverages", price: 0 }, { name: "Festival Choc", cat: "Beverages", price: 0 },
        { name: "Ceres Bottle", cat: "Beverages", price: 0 }, { name: "Arizona", cat: "Beverages", price: 0 },
        { name: "Abest Coffee", cat: "Beverages", price: 0 }, { name: "Champagne", cat: "Beverages", price: 0 },
        { name: "Scavi & Ray", cat: "Beverages", price: 0 }, { name: "Apple Juice", cat: "Beverages", price: 0 },
        { name: "Darling", cat: "Alcoholic", price: 0 }, { name: "Panache", cat: "Alcoholic", price: 0 },
        { name: "Kiss", cat: "Alcoholic", price: 0 }, { name: "Faxe", cat: "Alcoholic", price: 0 },
        { name: "Stella Artois", cat: "Alcoholic", price: 0 }, { name: "Budweiser", cat: "Alcoholic", price: 0 },
        { name: "Brutal Fruit", cat: "Alcoholic", price: 0 }, { name: "Hunters", cat: "Alcoholic", price: 0 },
        { name: "8pm M/S", cat: "Alcoholic", price: 0 }, { name: "8pm S/S", cat: "Alcoholic", price: 0 },
        { name: "8pm B/S", cat: "Alcoholic", price: 0 }, { name: "Afribull", cat: "Alcoholic", price: 0 },
        { name: "Red Label", cat: "Alcoholic", price: 0 }, { name: "Black Label", cat: "Alcoholic", price: 0 },
        { name: "Obuasi Gringo", cat: "Alcoholic", price: 0 }, { name: "Old Admiral S/S", cat: "Alcoholic", price: 0 },
        { name: "Old Admiral M/S", cat: "Alcoholic", price: 0 }, { name: "Old Admiral B/S", cat: "Alcoholic", price: 0 },
        { name: "Obuasi Btl", cat: "Alcoholic", price: 0 }, { name: "Strawberry Btl", cat: "Alcoholic", price: 0 },
        { name: "Charlie Btl", cat: "Alcoholic", price: 0 }, { name: "Jojo", cat: "Alcoholic", price: 0 },
        { name: "Schnapp Rubber", cat: "Alcoholic", price: 0 }, { name: "Schnapp Kente", cat: "Alcoholic", price: 0 },
        { name: "Schnapp Local", cat: "Alcoholic", price: 0 }, { name: "Coke B/S", cat: "Alcoholic", price: 0 },
        { name: "Captain Morgan", cat: "Alcoholic", price: 0 }, { name: "Don Luciano", cat: "Alcoholic", price: 0 },
        { name: "JP Chenet", cat: "Alcoholic", price: 0 }, { name: "Wine", cat: "Alcoholic", price: 0 },
        { name: "DeRay Ginger", cat: "Alcoholic", price: 0 }, { name: "DeRay Bottle", cat: "Alcoholic", price: 0 },
        { name: "Amuzu Bottle", cat: "Alcoholic", price: 0 }, { name: "Lime Bottle", cat: "Alcoholic", price: 0 },
        { name: "Vody", cat: "Alcoholic", price: 0 }, { name: "Bullet", cat: "Alcoholic", price: 0 },
        { name: "Smirnoff can", cat: "Alcoholic", price: 0 }, { name: "Club B/S", cat: "Alcoholic", price: 0 },
        { name: "Club Mini", cat: "Alcoholic", price: 0 }, { name: "Orijin B/S", cat: "Alcoholic", price: 0 },
        { name: "Orijin mini", cat: "Alcoholic", price: 0 }, { name: "Shandy B/S", cat: "Alcoholic", price: 0 },
        { name: "Shandy Mini", cat: "Alcoholic", price: 0 }, { name: "Kings Bottle", cat: "Alcoholic", price: 0 },
        { name: "Eagle Black", cat: "Alcoholic", price: 0 }, { name: "Eagle white", cat: "Alcoholic", price: 0 },
        { name: "Guinness", cat: "Alcoholic", price: 0 }, { name: "Smirnoff Bottle", cat: "Alcoholic", price: 0 },
        { name: "Smirnoff Punch", cat: "Alcoholic", price: 0 }, { name: "Gulder", cat: "Alcoholic", price: 0 },
        { name: "Alomo Btl", cat: "Alcoholic", price: 0 }, { name: "Choice sachets", cat: "Sachets", price: 0 },
        { name: "Adonko 123", cat: "Sachets", price: 0 }, { name: "Goal sac", cat: "Sachets", price: 0 },
        { name: "Alomo sac", cat: "Sachets", price: 0 }, { name: "Black Rock", cat: "Sachets", price: 0 },
        { name: "K20 sac", cat: "Sachets", price: 0 }, { name: "Tonic wine", cat: "Sachets", price: 0 },
        { name: "Kpoo Keke", cat: "Sachets", price: 0 }, { name: "Herb Afrik", cat: "Sachets", price: 0 },
        { name: "Striker sac", cat: "Sachets", price: 0 }, { name: "Madingo sac", cat: "Sachets", price: 0 },
        { name: "Obuasi 442", cat: "Sachets", price: 0 }, { name: "Round 2", cat: "Sachets", price: 0 },
        { name: "Castle Bridge", cat: "Sachets", price: 0 }, { name: "Sewa sac", cat: "Sachets", price: 0 },
        { name: "Fantasy", cat: "IceCream", price: 0 }, { name: "Frosty 150ml", cat: "IceCream", price: 0 },
        { name: "Chicken", cat: "Misc", price: 0 }, { name: "Biscuits", cat: "Misc", price: 0 }
    ].map((item, index) => ({ ...item, id: index + 1 }));

    let salesTotal = 0; let expenses = []; let currentCat = "Beverages";

    function startSync() {
        db.ref('lounge_data').on('value', (s) => {
            const data = s.val();
            if (data) { 
                inventory = data.inventory || inventory; 
                salesTotal = data.salesTotal || 0; 
                expenses = data.expenses || []; 
            } else { 
                save(); 
            }
            render();
        });
    }

    function render() {
        // Render Category Tabs
        const cats = ["Beverages", "Alcoholic", "Sachets", "IceCream", "Misc"];
        document.getElementById('cat-tabs-ui').innerHTML = cats.map(c => 
            `<button onclick="setCat('${c}')" class="cat-tab ${currentCat===c?'active':''}">${c}</button>`
        ).join('');

        // Render Sales Grid (The Buttons)
        const grid = document.getElementById('item-grid');
        const filtered = inventory.filter(i => i.cat === currentCat);
        grid.innerHTML = filtered.map(i => `
            <button class="item-btn" onclick="sell(${i.id})">
                ${i.name || "Unknown"}<br>₵${(i.price || 0).toFixed(2)}
            </button>
        `).join('');

        // Render Inventory Table (Management)
        document.getElementById('inventory-body').innerHTML = inventory.map(i => `
            <tr>
                <td>${i.name || "Unknown"}</td>
                <td><input type="number" value="${i.price || 0}" onchange="upd(${i.id}, this.value)"></td>
            </tr>
        `).join('');

        // Updates Totals
        document.getElementById('total-val').innerText = "₵" + (salesTotal || 0).toFixed(2);
        document.getElementById('rep-rev').innerText = "₵" + (salesTotal || 0).toFixed(2);
        const expT = expenses.reduce((a, b) => a + parseFloat(b.amount || 0), 0);
        document.getElementById('rep-exp').innerText = "₵" + expT.toFixed(2);
    }

    function setCat(c) { currentCat = c; render(); }

    function sell(id) { 
        const item = inventory.find(x => x.id === id);
        if(item) {
            salesTotal += parseFloat(item.price || 0); 
            save(); 
        }
    }

    function upd(id, p) { 
        const item = inventory.find(x => x.id === id);
        if(item) {
            item.price = parseFloat(p) || 0; 
            save(); 
        }
    }

    function addExp() { 
        const n = document.getElementById('exp-name').value; 
        const a = document.getElementById('exp-amt').value; 
        if(n && a) { 
            expenses.push({name:n, amount:parseFloat(a)}); 
            save(); 
            document.getElementById('exp-name').value = '';
            document.getElementById('exp-amt').value = '';
        } 
    }

    function save() { 
        db.ref('lounge_data').set({
            inventory: inventory, 
            salesTotal: salesTotal, 
            expenses: expenses
        }); 
    }

    function showPage(id) { 
        document.querySelectorAll('.page-content').forEach(p => p.style.display='none'); 
        document.getElementById(id).style.display='block'; 
    }

    function resetDay() { 
        if(confirm("Are you sure you want to reset all sales and expenses for a new day?")) { 
            salesTotal = 0; 
            expenses = []; 
            save(); 
        } 
    }

    function exportToExcel() {
        let reportData = [
            ["Ojoo Amisty Lounge - Daily Report"],
            ["Type", "Name", "Amount"],
            ["REVENUE", "Total Sales", salesTotal.toFixed(2)]
        ];
        expenses.forEach(e => reportData.push(["EXPENSE", e.name, parseFloat(e.amount).toFixed(2)]));
        reportData.push(["---", "---", "---"]);
        reportData.push(["NET PROFIT", "", (salesTotal - expenses.reduce((a,b)=>a+parseFloat(b.amount),0)).toFixed(2)]);

        let ws = XLSX.utils.aoa_to_sheet(reportData);
        let wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "DailyReport");
        XLSX.writeFile(wb, "Ojoo_Lounge_Report.xlsx");
    }
</script>
